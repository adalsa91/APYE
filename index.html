<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>APYE by adalsa91</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">APYE</h1>
        <p class="header">Proyecto para la asignatura de Infraestructura Virtual 2016-2017</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/adalsa91/APYE/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/adalsa91/APYE/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/adalsa91/APYE">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/adalsa91">adalsa91</a></p>


      </header>
      <section>
        <h1>
<a id="apye" class="anchor" href="#apye" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>APYE</h1>

<p><a href="https://travis-ci.org/adalsa91/APYE"><img src="https://travis-ci.org/adalsa91/APYE.svg?branch=master" alt="Build Status"></a></p>

<p>Proyecto para la asignatura de Infraestructura Virtual 2016-2017</p>

<h3>
<a id="ejercicios-tema-2" class="anchor" href="#ejercicios-tema-2" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><a href="https://github.com/adalsa91/EjercicioIV/blob/master/Tema2.md">Ejercicios Tema 2</a>
</h3>

<h2>
<a id="descripción" class="anchor" href="#descripci%C3%B3n" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Descripción</h2>

<p>La aplicación consiste en un gestor de ficheros que junto a un editor de texto permitirá al usuario la creación y edición de scripts de python, quedando estos almacenados permanentemente entre sesiones, posibilitando la opción de ejecutar estos scripts en un entorno virtual y seguro que devolverá los resultados del programa en pantalla.</p>

<h1>
<a id="hito-2-integración-continua" class="anchor" href="#hito-2-integraci%C3%B3n-continua" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Hito 2: Integración continua</h1>

<h2>
<a id="requisitos" class="anchor" href="#requisitos" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Requisitos</h2>

<p>Para la descripción de las dependencias de la aplciación se ha creado un archivo <em>requeriments.txt</em> que suele ser el nombre usado por convención en Python.</p>

<pre><code>click==6.6
Flask==0.11.1
gunicorn==19.6.0
itsdangerous==0.24
Jinja2==2.8
MarkupSafe==0.23
Werkzeug==0.11.11
psycopg2==2.6.2
SQLAlchemy==1.1.2
Flask-SQLAlchemy==2.1
Flask-Migrate==2.0.0
Flask-Testing==0.6.1
Flask-Login==0.4.0
Flask-WTF==0.13.1
WTForms==2.1

</code></pre>

<h2>
<a id="tests" class="anchor" href="#tests" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Tests</h2>

<p>Para asegurar el correcto funcionamiento de la aplicación antes de ser desplegada se han escrito los siguientes tests. Para la automatización de los test se ha usado el framework de test <strong>unittest</strong> de Python, que además de orquestar la ejecución de los test proporciona una clase base llamada <em>TestCase</em> que podemos usar para crear nuevos casos de prueba, esta clase incluye métodos como *<em>setUp</em> o <em>tearDown</em> que permiten configurar un entorno funcional para la realización de los test y limpiarlo todo tras las pruebas.</p>

<div class="highlight highlight-source-python"><pre><span class="pl-k">import</span> unittest
<span class="pl-k">import</span> os
<span class="pl-k">import</span> shutil
<span class="pl-k">from</span> app <span class="pl-k">import</span> app, db
<span class="pl-k">from</span> models <span class="pl-k">import</span> User
<span class="pl-k">from</span> flask_login <span class="pl-k">import</span> current_user


<span class="pl-k">class</span> <span class="pl-en">ApyeTestCase</span>(<span class="pl-e">unittest</span>.<span class="pl-e">TestCase</span>):
    <span class="pl-s"><span class="pl-pds">"""</span>A base test case for flask-tracking.<span class="pl-pds">"""</span></span>

    <span class="pl-k">def</span> <span class="pl-en">create_app</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>):
        app.config.from_object(<span class="pl-s"><span class="pl-pds">'</span>config.TestConfiguration<span class="pl-pds">'</span></span>)
        <span class="pl-k">return</span> app

    <span class="pl-k">def</span> <span class="pl-en">setUp</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>):
        db.session.close()
        db.drop_all()
        db.create_all()
        <span class="pl-v">self</span>.app <span class="pl-k">=</span> app.test_client()
        <span class="pl-k">if</span> <span class="pl-k">not</span> os.path.exists(<span class="pl-s"><span class="pl-pds">'</span>users/<span class="pl-pds">'</span></span>):
            os.makedirs(<span class="pl-s"><span class="pl-pds">'</span>users/<span class="pl-pds">'</span></span>)

    <span class="pl-k">def</span> <span class="pl-en">tearDown</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>):
        db.session.remove()
        db.drop_all()
        shutil.rmtree(<span class="pl-s"><span class="pl-pds">'</span>users<span class="pl-pds">'</span></span>)

    <span class="pl-k">def</span> <span class="pl-en">test_adduser</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>):
        usuario <span class="pl-k">=</span> User(<span class="pl-s"><span class="pl-pds">'</span>adrian<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>adalsa@correo.ugr.es<span class="pl-pds">'</span></span>,
                       <span class="pl-s"><span class="pl-pds">'</span>password<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>Adrian<span class="pl-pds">'</span></span>, <span class="pl-c1">True</span>)
        db.session.add(usuario)
        db.session.commit()
        usuarios <span class="pl-k">=</span> User.query.all()
        <span class="pl-k">assert</span> usuario <span class="pl-k">in</span> usuarios
        <span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>[OK] Usuario creado satisfactoriamente<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>)

    <span class="pl-k">def</span> <span class="pl-en">test_home_user</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>):
        <span class="pl-k">if</span> <span class="pl-k">not</span> os.path.exists(<span class="pl-s"><span class="pl-pds">'</span>users/<span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span>adrian<span class="pl-pds">'</span></span>):
            os.makedirs(<span class="pl-s"><span class="pl-pds">'</span>users/<span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span>adrian<span class="pl-pds">'</span></span>)
        f <span class="pl-k">=</span> <span class="pl-c1">open</span>(<span class="pl-s"><span class="pl-pds">'</span>users/adrian/Welcome<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>w+<span class="pl-pds">'</span></span>)
        f.write(<span class="pl-s"><span class="pl-pds">'</span>Welcome!<span class="pl-pds">'</span></span>)
        f.seek(<span class="pl-c1">0</span>)
        <span class="pl-k">assert</span> f.read() <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>Welcome!<span class="pl-pds">'</span></span>
        f.close()
        <span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>[OK] Entorno de usuario creado correctamente<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>)

    <span class="pl-k">def</span> <span class="pl-en">test_login_logout</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>):
        usuario <span class="pl-k">=</span> User(<span class="pl-s"><span class="pl-pds">'</span>jorge<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>jorge@correo.ugr.es<span class="pl-pds">'</span></span>,
                       <span class="pl-s"><span class="pl-pds">'</span>password<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>Jorge Nitales<span class="pl-pds">'</span></span>, <span class="pl-c1">True</span>)
        db.session.add(usuario)
        db.session.commit()

        <span class="pl-k">with</span> <span class="pl-v">self</span>.app:
            <span class="pl-c"># Login</span>
            response <span class="pl-k">=</span> <span class="pl-v">self</span>.app.post(
                <span class="pl-s"><span class="pl-pds">'</span>/login<span class="pl-pds">'</span></span>, <span class="pl-v">data</span><span class="pl-k">=</span>{<span class="pl-s"><span class="pl-pds">'</span>username<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>jorge<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>password<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>password<span class="pl-pds">'</span></span>},
                <span class="pl-v">follow_redirects</span><span class="pl-k">=</span><span class="pl-c1">True</span>)
            <span class="pl-k">assert</span> current_user.username <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>jorge<span class="pl-pds">'</span></span>
            <span class="pl-k">assert</span> <span class="pl-s"><span class="pl-k">b</span><span class="pl-pds">'</span>Success<span class="pl-pds">'</span></span> <span class="pl-k">in</span> response.data

            <span class="pl-c"># Logout</span>
            response <span class="pl-k">=</span> <span class="pl-v">self</span>.app.post(
                <span class="pl-s"><span class="pl-pds">'</span>/logout<span class="pl-pds">'</span></span>, <span class="pl-v">follow_redirects</span><span class="pl-k">=</span><span class="pl-c1">True</span>)
            <span class="pl-k">assert</span> current_user.is_anonymous

        <span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>[OK] Usuarios registrados pueden identificarse correctamente<span class="pl-pds">"</span></span>)

<span class="pl-k">if</span> <span class="pl-c1">__name__</span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>__main__<span class="pl-pds">'</span></span>:
    unittest.main()
</pre></div>

<p>Para ejecutar los tests utilizamos la función <strong>discover</strong> de <em>unittest</em>:</p>

<div class="highlight highlight-source-shell"><pre>    python -m unittest discover
</pre></div>

<p>Este comando busca recursivamente tests desde el directorio en el que lo lanzamos.</p>

<p><img src="https://raw.githubusercontent.com/adalsa91/APYE/documentacion/images/hito2/image1.png" alt="Resultados tests" title="Resultados tests"></p>

<p>Para simplificar el lanzamiento de tests y otras tareas creamos un <strong>Makefile</strong>:</p>

<div class="highlight highlight-source-makefile"><pre><span class="pl-en">install</span>:
    pip install -r requirements.txt

<span class="pl-en">test</span>:
    python -m unittest discover

<span class="pl-en">run</span>:    
    python manage.py runserver
</pre></div>

<h2>
<a id="integración-continua" class="anchor" href="#integraci%C3%B3n-continua" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Integración Continua</h2>

<p>Para este paso usamos el sistema de integración continua <strong>Travis</strong>, el mótivo de la elección es debido a su popularidad y documentación.</p>

<p>El primer paso es sincronizar <em>Travis</em> con nuestro <em>GitHub</em>, para ello iniciamos sesión en <em>Travis</em> con nuestra cuenta de <em>GitHub</em> y activamos el repositorio que queremos conectar en la página de nuestro perfil de <em>Travis</em>.</p>

<p><img src="https://raw.githubusercontent.com/adalsa91/APYE/documentacion/images/hito2/image2.png" alt="Activación repositorio en perfil Travis" title="Activación repositorio en perfil Travis"></p>

<p>A continuación creamos el archivo <code>.travis.yml</code> en el que especificaremosel lenguaje y versión usados, además de otros datos necesarios para construir el entorno de ejecución y el comando para ejecutar los tests.</p>

<div class="highlight highlight-source-makefile"><pre><span class="pl-en">language</span>: python
<span class="pl-en">python</span>:
  - "3.4"

<span class="pl-en">install</span>: "pip install -r requirements.txt"

<span class="pl-en">services</span>:
  postgresql

<span class="pl-en">before_script</span>:
  - psql -c "create user apye with password 'iDDLpkP1uv' " -U postgres
  - psql -c "create database apye_users;" -U postgres
  - psql -c "grant all privileges on database apye_users to apye;" -U postgres
  - python manage.py db upgrade

<span class="pl-en">script</span>: python test_base.py

</pre></div>

<p>También necesitaremos definir las variables de entorno necsarias para la aplicación, podemos hacerlo en el fichero anterior o en la interfaz web.</p>

<p><img src="https://raw.githubusercontent.com/adalsa91/APYE/documentacion/images/hito2/image3.png" alt="Variables de entorno en Travis" title="Variables de entorno en Travis"></p>

<p>Una vez todo esté configurado hacemos un add --&gt; commit --&gt; push y Travis detectará los cambios en nuestro repositorio de GitHub y lanzará los tests. Podemos comprobar el resultado en la página web de <em>Travis</em>.
<img src="https://raw.githubusercontent.com/adalsa91/APYE/documentacion/images/hito2/image4.png" alt="Build History" title="Build History"></p>

<p><img src="https://raw.githubusercontent.com/adalsa91/APYE/documentacion/images/hito2/image5.png" alt="Log Travis" title="Log Travis"></p>

<p>Además Travis nos ofrece un incrustable que demuestra el estado actual del repositorio.</p>

<p><a href="https://travis-ci.org/adalsa91/APYE"><img src="https://travis-ci.org/adalsa91/APYE.svg?branch=master" alt="Build Status"></a></p>

<h2>
<a id="hito-3-despliegue-en-un-paas" class="anchor" href="#hito-3-despliegue-en-un-paas" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Hito 3: Despliegue en un Paas</h2>

<p>En primer lugar instalamos <a href="https://devcenter.heroku.com/articles/getting-started-with-python#set-up"><strong>Heroku CLI</strong></a> con el siguiente comando:</p>

<div class="highlight highlight-source-shell"><pre>$ wget -O- https://toolbelt.heroku.com/install-ubuntu.sh <span class="pl-k">|</span> sh</pre></div>

<p>Una vez instalado iniciamos sesión.</p>

<p><img src="https://raw.githubusercontent.com/adalsa91/APYE/documentacion/images/hito3/image1.png" alt="Inicio de sesión en Heroku con CLI" title="Inicio de sesión en Heroku con CLI"></p>

<p>Ahora creamos la aplicación, en mi caso he creado una para producción y otra para pruebas.</p>

<div class="highlight highlight-source-shell"><pre>$ heroku create apye-pro
$ heroku create apye-stage</pre></div>

<p>Y los añadimos a los remotos.</p>

<div class="highlight highlight-source-shell"><pre>$ git remote add pro git@heroku.com:apye-pro.git
$ git remote add stage git@heroku.com:apye-stage.git</pre></div>

<p>Creamos un fichero Procfile en la raíz de la aplciación para declarar que comandos deben ser ejecutados al iniciar la aplicación.</p>

<pre><code>web: gunicorn app:app

</code></pre>

<p>También tenemos que especificar la versión de Python que necesita nuestra aplicación, para ello creamos el fichero <code>runtime.txt</code> con el siguiente contenido.</p>

<pre><code>python-3.4.2
</code></pre>

<p>El resto de dependencias de la aplicación están en el fichero <code>requeriments.txt</code> en la raíz del proyecto y Heroku lo detectará automáticamente.</p>

<p>Debemos definir las variables de entorno, para ello usaremos las herramientas de la CLI.</p>

<div class="highlight highlight-source-shell"><pre>$ heroku config:<span class="pl-c1">set</span> APP_SETTINGS=config.ProductionConfig --remote pro
$ heroku config:<span class="pl-c1">set</span> SECRET_KEY=SuperSecretKey --remote pro
$ heroku config:<span class="pl-c1">set</span> APP_SETTINGS=config.ProductionConfig --remote stage
$ heroku config:<span class="pl-c1">set</span> SECRET_KEY=SuperSecretKey --remote stage</pre></div>

<p>Ya podemos hacer un push a heroku.
<img src="https://raw.githubusercontent.com/adalsa91/APYE/documentacion/images/hito3/image2.png" alt="Push a Heroku" title="Push a Heroku"></p>

<p>Ahora podemos iniciar la aplicación en local con <code>heroku local</code>.</p>

<p><img src="https://raw.githubusercontent.com/adalsa91/APYE/documentacion/images/hito3/image5.png" alt="Heroku local" title="Heroku local"></p>

<div class="highlight highlight-source-shell"><pre>    heroku <span class="pl-k">local</span> web</pre></div>

<p>Antes de poder lanzar la aplicación en remoto tendremos que configurar <em>PostgreSQL</em> en <em>Heroku</em>, para ello añadimos un addon tanto al servidor de stage como al pro.</p>

<div class="highlight highlight-source-shell"><pre>$ heroku addons:create heroku-postgresql:hobby-dev --app apye-stage
$ heroku addons:create heroku-postgresql:hobby-dev --app apye-pro</pre></div>

<p>Con el comando <code>config</code> del CLI de <em>Heroku</em> podemos comprobar que efectivamente se ha creado la base de datos y la correspondiente variable de entorno.</p>

<p><img src="https://raw.githubusercontent.com/adalsa91/APYE/documentacion/images/hito3/image6.png" alt="Variable de entorno bd Heroku" title="Variable de entorno bd Heroku"></p>

<p>Actualizamos la base de datos con las migraciones.</p>

<div class="highlight highlight-source-shell"><pre>$ heroku run python manage.py db upgrade --app apye-pro
$ heroku run python manage.py db upgrade --app apye-stage</pre></div>

<p><img src="https://raw.githubusercontent.com/adalsa91/APYE/documentacion/images/hito3/image7.png" alt="Actualización base de datos Heroku" title="Actualización base de datos Heroku"></p>

<p>Podemos comprobar que todo está funcionando correctamente lanzando los tests.</p>

<p><img src="https://raw.githubusercontent.com/adalsa91/APYE/documentacion/images/hito3/image8.png" alt="Resultado tests Heroku" title="Resultado tests Heroku"></p>

<p>Conectamos la aplicación de Heroku con el respositorio de GitHub para activar el despliegue automático, activando la opción de comprobocación de tests para que el despliegue no se realice hasta que Travis CI ejecute los tests con éxito.</p>

<p><img src="images/hito3/image9.png" alt="Despliegue automático de GitHub a Heroku" title="Despliegue automático de GitHub a Heroku"></p>

<p>Por último añadimos un botón para poder desplegar el repositorio de GitHub automáticamente a Heroku, para ello creamos una fichero <code>app.json</code> en la raíz del proyecto con la descripción de la aplicación, enlace al repositorio, addons de Heroku  y variables de entorno necesarios.</p>

<pre><code>{
  "name": "APYE",
  "description": "Editor online de Python",
  "image": "heroku/python",
  "repository": "https://github.com/adalsa91/APYE",
  "logo": "https://www.herokucdn.com/deploy/button.svg",
  "keywords": ["python", "flask" ],
  "addons": [ "heroku-postgresql" ],
  "env": {
      "SECRET_KEY": {
          "description": "A secret key for verifying the integrity of signed cookies.",
          "generator": "secret"
      },
      "APP_SETTINGS": {
          "description": "Determine environment.",
          "value": "config.ProductionConfig"
      }
  }
}
</code></pre>

<p>Con el siguiente fragmento en <em>Markdown</em> insertamos el botón.</p>

<pre><code>[![Deploy](https://www.herokucdn.com/deploy/button.svg)](https://heroku.com/deploy)
</code></pre>

<p><a href="https://heroku.com/deploy"><img src="https://www.herokucdn.com/deploy/button.svg" alt="Deploy"></a></p>

<blockquote>
<p>Adrián Álvarez Sáez</p>
</blockquote>
      </section>
      <footer>
        <p><small>Hosted on <a href="https://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		
  </body>
</html>
